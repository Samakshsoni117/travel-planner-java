<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Travel Itinerary Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        @keyframes pulse-bg {
            0%, 100% { background-color: #e2e8f0; }
            50% { background-color: #cbd5e1; }
        }
        .animate-pulse-bg {
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-gray-800">

    <main class="w-full max-w-4xl glass-effect text-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-8 md:p-12">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Smart Travel Itinerary</h1>
                <p class="text-lg text-gray-300">Tell me your travel plans, and I'll craft the perfect itinerary!</p>
            </header>

            <!-- Input Section -->
            <div id="input-section">
                <label for="prompt-input" class="block mb-2 font-medium text-gray-200">Describe your trip:</label>
                <textarea id="prompt-input" rows="4" class="w-full p-4 rounded-lg bg-white bg-opacity-10 border border-gray-400 focus:ring-2 focus:ring-teal-400 focus:outline-none transition text-white placeholder-gray-400" placeholder="e.g., 'A 4-day adventurous trip to Costa Rica for a couple on a medium budget, focused on wildlife and hiking.'"></textarea>
                <button id="generate-btn" class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-teal-400 shadow-lg">
                    <span class="btn-text">Generate Itinerary</span>
                    <span class="btn-loader hidden items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating...
                    </span>
                </button>
            </div>

            <!-- Error Box -->
            <div id="error-box" class="hidden mt-6 p-4 bg-red-500 bg-opacity-50 text-white rounded-lg border border-red-600">
                <p><strong class="font-bold">Oops!</strong> <span id="error-message"></span></p>
                <button id="try-again-btn" class="mt-2 text-sm font-semibold underline">Try Again</button>
            </div>

            <!-- Loading Skeleton -->
            <div id="loading-skeleton" class="hidden mt-8 space-y-6">
                 <div class="w-3/4 h-8 rounded animate-pulse-bg mx-auto"></div>
                 <div class="w-full h-4 rounded animate-pulse-bg"></div>
                 <div class="space-y-4 pt-4">
                    <div class="w-1/4 h-6 rounded animate-pulse-bg"></div>
                    <div class="w-full h-4 rounded animate-pulse-bg"></div>
                    <div class="w-3/4 h-4 rounded animate-pulse-bg"></div>
                </div>
                 <div class="space-y-4 pt-4">
                    <div class="w-1/4 h-6 rounded animate-pulse-bg"></div>
                    <div class="w-full h-4 rounded animate-pulse-bg"></div>
                    <div class="w-2/3 h-4 rounded animate-pulse-bg"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-8">
                <div class="text-center">
                    <h2 id="itinerary-title" class="text-3xl font-bold text-white"></h2>
                    <p id="itinerary-summary" class="mt-2 text-gray-300"></p>
                </div>
                <div id="daily-plan-container" class="mt-6 space-y-6">
                    <!-- Daily plans will be injected here -->
                </div>
                <div class="mt-8 flex justify-center space-x-4">
                     <button id="start-over-btn" class="bg-gray-600 bg-opacity-50 hover:bg-opacity-75 text-white font-bold py-2 px-6 rounded-lg transition">Start Over</button>
                     <button id="copy-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition">Copy Itinerary</button>
                </div>
            </div>

        </div>
        <footer class="text-center py-4 text-sm text-gray-400 bg-black bg-opacity-20">
            Created by Samaksh
        </footer>
    </main>
    
    <!-- Hidden textarea for copy functionality -->
    <textarea id="copy-text-area" class="absolute -left-full"></textarea>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const promptInput = document.getElementById('prompt-input');
        const inputSection = document.getElementById('input-section');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const loadingSkeleton = document.getElementById('loading-skeleton');
        const resultsSection = document.getElementById('results-section');
        const itineraryTitle = document.getElementById('itinerary-title');
        const itinerarySummary = document.getElementById('itinerary-summary');
        const dailyPlanContainer = document.getElementById('daily-plan-container');
        const startOverBtn = document.getElementById('start-over-btn');
        const copyBtn = document.getElementById('copy-btn');
        const copyTextArea = document.getElementById('copy-text-area');

        const btnText = document.querySelector('.btn-text');
        const btnLoader = document.querySelector('.btn-loader');

        const API_URL = '/api/itinerary/generate'; // The endpoint of your Java app

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerateClick);
        startOverBtn.addEventListener('click', () => {
            resultsSection.classList.add('hidden');
            inputSection.classList.remove('hidden');
            promptInput.value = '';
        });
        tryAgainBtn.addEventListener('click', () => {
            errorBox.classList.add('hidden');
            inputSection.classList.remove('hidden');
        });

        copyBtn.addEventListener('click', () => {
            const itineraryText = generateTextForCopy();
            copyTextArea.value = itineraryText;
            copyTextArea.select();
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'Copy Itinerary'; }, 2000);
        });

        // --- Main Functions ---
        async function handleGenerateClick() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                showError("Please describe your trip before generating an itinerary.");
                return;
            }

            setLoadingState(true);

            try {
                const responseText = await callGeminiAPI(userPrompt);
                if (!responseText) return; 

                const itineraryData = parseAIResponse(responseText);
                if (!itineraryData) return;

                renderItinerary(itineraryData);
                showResults();

            } catch (error) {
                console.error("An unexpected error occurred:", error);
                showError("An unexpected error occurred. Please check the server logs.");
            } finally {
                setLoadingState(false);
            }
        }

        async function callGeminiAPI(userPrompt) {
            const payload = {
                prompt: userPrompt
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error("API Error Response:", errorData);
                    showError(`The server responded with an error (Status: ${response.status}). Please try again.`);
                    return null;
                }
                return await response.text();

            } catch (networkError) {
                console.error("Network error:", networkError);
                showError("A network error occurred. Please check your connection and try again.");
                return null;
            }
        }
        
        function parseAIResponse(responseText) {
            try {
                // The backend now returns a stringified JSON directly.
                const parsedJson = JSON.parse(responseText);

                // Basic validation
                if (!parsedJson.title || !parsedJson.daily_plan) {
                    throw new Error("Missing required fields in AI response.");
                }
                return parsedJson;
            } catch (error) {
                console.error("Failed to parse AI response:", error);
                showError("The AI returned an invalid response. Please try again.");
                return null;
            }
        }

        // --- THIS FUNCTION IS NOW FULLY CORRECTED ---
        function renderItinerary(data) {
            itineraryTitle.textContent = data.title;
            itinerarySummary.textContent = data.summary;
            dailyPlanContainer.innerHTML = ''; // Clear previous results

            data.daily_plan.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'p-4 rounded-lg bg-black bg-opacity-20';
                
                let activitiesHtml = day.activities.map(activity => {
                    if (typeof activity === 'object' && activity !== null) {
                        const description = activity.description || activity.activity || activity.task || 'No description provided.';
                        return `<li class="mb-1">${description}</li>`;
                    }
                    return `<li class="mb-1">${activity}</li>`;
                }).join('');

                // THIS IS THE FINAL FIX: Correctly access day.day and day.title
                const dayNumber = day.day || 'Day';
                const dayTitle = day.title || 'Details';

                dayElement.innerHTML = `
                    <h3 class="text-xl font-bold text-teal-300">${dayNumber}: ${dayTitle}</h3>
                    <ul class="list-disc list-inside mt-2 text-gray-300">
                        ${activitiesHtml}
                    </ul>
                `;
                dailyPlanContainer.appendChild(dayElement);
            });
        }
        
        function generateTextForCopy() {
            let text = `${itineraryTitle.textContent}\n\n`;
            text += `${itinerarySummary.textContent}\n\n`;
            
            document.querySelectorAll('#daily-plan-container > div').forEach(dayEl => {
                const title = dayEl.querySelector('h3').textContent;
                text += `${title}\n`;
                dayEl.querySelectorAll('li').forEach(li => {
                    text += `- ${li.textContent}\n`;
                });
                text += '\n';
            });
            return text;
        }

        // --- UI State Changers ---
        function setLoadingState(isLoading) {
            if (isLoading) {
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
                btnLoader.classList.add('flex');
                generateBtn.disabled = true;
                inputSection.classList.add('hidden');
                errorBox.classList.add('hidden');
                loadingSkeleton.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
                btnLoader.classList.remove('flex');
                generateBtn.disabled = false;
                loadingSkeleton.classList.add('hidden');
            }
        }

        function showResults() {
            resultsSection.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            inputSection.classList.add('hidden');
            errorBox.classList.remove('hidden');
        }

    </script>
</body>
</html>

